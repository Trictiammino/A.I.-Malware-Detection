from matplotlib import pyplot as plt
from sklearn.neighbors import KNeighborsClassifier
from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay, classification_report
import functions


# path dei file
X_filtered_path = "dataset/X_filtered.csv"
Train_Y_path = "dataset/EmberYTrain.csv"
Test_X_path = "dataset/EmberTest/EmberXTest.csv"
Test_Y_path = "dataset/EmberTest/EmberYTest.csv"

# caricamento dei file
Y = functions.load(Train_Y_path)
X = functions.load(X_filtered_path)
Ember_X_Test = functions.load(Test_X_path)
Ember_Y_Test = functions.load(Test_Y_path)

# conversione di Y in array
Y_array = Y['Label'].values

# Mutual Info rank calcolato su X_filtered
rank = functions.mutual_info_rank(X, Y)

# inizializzazione della soglia minima e della soglia massima e dello step con cui muoversi tra le due soglie
min_threshold = 0
max = 0.0
for key in rank:
    if key[1] >= max:
        max = key[1]
print("\n\nSoglia massima:", max, "\n\n")
step_threshold = 0.02
max_threshold = max + step_threshold

# settaggio del numero di fold da effettuare tramite il K-Fold Stratificato
folds = 5

# esecuzione del K-fold Stratificato su X
ListXTrain, ListXTest, ListYTrain, ListYTest = functions.stratified_k_fold(X, Y, folds)

# esecuzione della ricerca dei migliori parametri per il KNN
best_k, best_f1, best_N, best_TH = functions.determine_KNN_k_fold_configuration(ListXTrain, ListYTrain, ListXTest, ListYTest, rank, min_threshold, max_threshold, step_threshold)
print("\n\nMIGLIORI PARAMETRI DEL KNN INDIVIDUATI:\nFeature Ranking tramite M.I.:\n", 'k: ', best_k, ', F: ', best_f1, ', N: ', best_N, ', soglia M.I.: ', best_TH, '\n')


# selezione dei nomi delle migliori feature utilizzando la migliore soglia individuata
toplist = functions.top_feature_select(rank, best_TH)
toplist_key = [coppia[0] for coppia in toplist]

# creazione del KNN con il miglior valore 'k' individuato
best_knn_classifier = KNeighborsClassifier(n_neighbors=best_k)

# addestramento del KNN con le migliori feature selezionate
best_knn_classifier.fit(X.loc[:, toplist_key], Y_array)

# filtraggio di EmberXTest.csv in base alle feature con cui il KNN Ã¨ stato addestrato (toplist_key)
Ember_X_Test_filtrato = Ember_X_Test[toplist_key]

# previsioni del KNN sul dataset di test
y_predicted = best_knn_classifier.predict(Ember_X_Test_filtrato)

# calcolo della matrice di confusione del KNN
conf_matrix_KNN = confusion_matrix(Ember_Y_Test, y_predicted)

# settaggio parametri per la visualizzazione della matrice di confusione del KNN
disp = ConfusionMatrixDisplay(confusion_matrix=conf_matrix_KNN)
disp.plot(cmap='Blues')
disp.ax_.set_title('Matrice di confusione del KNN')

# visualizzazione della matrice di confusione del KNN
plt.show()

# stampa del report di classificazione del KNN
class_report_KNN = classification_report(Ember_Y_Test, y_predicted)
print("\nReport di classificazione del KNN:\n")
print(class_report_KNN, "\n")
